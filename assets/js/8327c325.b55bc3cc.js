"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[80],{6599:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>g,frontMatter:()=>t,metadata:()=>l,toc:()=>d});var s=i(4848),r=i(8453);const t={slug:"/logs",sidebar_position:5},a="Logs",l={id:"logs/logs",title:"Logs",description:"CubeAPM supports aggregating logs from a wide range of agents - Elastic (Logstash, Fluent, etc.), Loki, OpenTelemetry, Vector, and more. It can ingest structured as well as unstructured logs.",source:"@site/docs/logs/logs.md",sourceDirName:"logs",slug:"/logs",permalink:"/logs",draft:!1,unlisted:!1,editUrl:"https://github.com/cubeapm/docs/docs/docs/logs/logs.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{slug:"/logs",sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Varnish Cache",permalink:"/infra-monitoring/varnish-cache"}},o={},d=[{value:"Integration",id:"integration",level:2},{value:"_msg",id:"_msg",level:3},{value:"_time",id:"_time",level:3},{value:"Stream fields",id:"stream-fields",level:3},{value:"Querying",id:"querying",level:2}];function c(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"logs",children:"Logs"}),"\n",(0,s.jsx)(n.p,{children:"CubeAPM supports aggregating logs from a wide range of agents - Elastic (Logstash, Fluent, etc.), Loki, OpenTelemetry, Vector, and more. It can ingest structured as well as unstructured logs."}),"\n",(0,s.jsx)(n.h2,{id:"integration",children:"Integration"}),"\n",(0,s.jsx)(n.p,{children:"CubeAPM receives logs data on the below endpoints:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"# Elastic\nhttp://<ip_address_of_cubeapm_server>:3130/api/logs/insert/elasticsearch/_bulk\n\n# Loki (Protobuf as well as JSON)\nhttp://<ip_address_of_cubeapm_server>:3130/api/logs/insert/loki/api/v1/push\n\n# OpenTelemetry Logs (Protobuf)\nhttp://<ip_address_of_cubeapm_server>:3130/api/logs/insert/opentelemetry/v1/logs\n\n# JSON (Newline delimited)\nhttp://<ip_address_of_cubeapm_server>:3130/api/logs/insert/jsonline\n"})}),"\n",(0,s.jsx)(n.p,{children:"Upon ingestion, each log entry is converted into an object with string keys and string values, e.g.,"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "_time": "2024-11-06T13:42:05.234Z",\n  "service": "order-service",\n  "host.name": "ip-10-0-129-151",\n  "host.ip": "10.0.129.151",\n  "trace_id": "22cba212a1b34d49b009a22fb13b82ee",\n  "_msg": "order rejected as some items are out of stock"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"If the incoming log has nested JSON, it is flattened. For example, the below incoming object will be converted to the one above:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "_time": "2024-11-06T13:42:05.234Z",\n  "service": "order-service",\n  "host": {\n    "name": "ip-10-0-129-151",\n    "ip": "10.0.129.151"\n  },\n  "trace_id": "22cba212a1b34d49b009a22fb13b82ee",\n  "_msg": "order rejected as some items are out of stock"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"There can be any arbitrary fields in the log message. Each field is indexed to provide full text search."}),"\n",(0,s.jsx)(n.p,{children:"Some field names have special significance in CubeAPM. These are described below:"}),"\n",(0,s.jsx)(n.h3,{id:"_msg",children:"_msg"}),"\n",(0,s.jsx)(n.p,{children:"This field provides support for unstructured logs. For example, an unstructured log entry (or some unstructured part within an otherwise structured log) can be ingested as:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{ "_msg": "this is an unstructured log message" }\n'})}),"\n",(0,s.jsxs)(n.p,{children:["If the message field has some other name than ",(0,s.jsx)(n.code,{children:"_msg"}),", it can be specified via ",(0,s.jsx)(n.code,{children:"_msg_field"})," URL query parameter or via ",(0,s.jsx)(n.code,{children:"Cube-Msg-Field"})," HTTP header in the data ingestion request. For example, if the log message is located in the ",(0,s.jsx)(n.code,{children:"event.description"})," field, then specify ",(0,s.jsx)(n.code,{children:"_msg_field=event.description"})," URL query parameter."]}),"\n",(0,s.jsx)(n.h3,{id:"_time",children:"_time"}),"\n",(0,s.jsx)(n.p,{children:"If the ingested log contains a field with this name, its value is taken as the timestamp of the log entry. Otherwise the ingestion timestamp is used. The value must be formatted in ISO8601, RFC3339, or Unix timestamp (seconds or milliseconds)."}),"\n",(0,s.jsxs)(n.p,{children:["If the time field has some other name than ",(0,s.jsx)(n.code,{children:"_time"}),", it can be specified via ",(0,s.jsx)(n.code,{children:"_time_field"})," URL query parameter or via ",(0,s.jsx)(n.code,{children:"Cube-Time-Field"})," HTTP header in the data ingestion request."]}),"\n",(0,s.jsx)(n.h3,{id:"stream-fields",children:"Stream fields"}),"\n",(0,s.jsxs)(n.p,{children:["Internally, CubeAPM organizes logs by ",(0,s.jsx)(n.em,{children:"streams"}),". Taking the analogy of filesystems, streams can be thought of as folders and individual log lines can be thought of as files. Organizing logs by streams is not mandatory but it helps in improving search experience as well as performance."]}),"\n",(0,s.jsxs)(n.p,{children:["Certain fields in the log entry can be designated as stream fields. A combination of the values of these fields will then uniquely identify the stream to which the log entry belongs. Stream fields can be specified via ",(0,s.jsx)(n.code,{children:"_stream_fields"})," URL query parameter or via ",(0,s.jsx)(n.code,{children:"Cube-Stream-Fields"})," HTTP header in the data ingestion request."]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsx)(n.p,{children:"Fields with low cardinality (i.e. less number of distinct values) are good candidates for using as stream fields, e.g., service.name, service.version, etc."}),(0,s.jsx)(n.p,{children:"Fields with high cardinality (i.e. large number of unique values) are bad candidates for using as stream fields, e.g., trace_id, ip_address, timestamp, etc. Using high cardinality fields as stream fields can significantly deteriorate the performance of CubeAPM."}),(0,s.jsx)(n.p,{children:"Note that CubeAPM allows searching over non-stream fields as well, so you can search over high cardinality fields even without designating them as stream fields."})]}),"\n",(0,s.jsx)(n.h2,{id:"querying",children:"Querying"}),"\n",(0,s.jsxs)(n.p,{children:["Start by selecting the appropriate stream fields from the ",(0,s.jsx)(n.code,{children:"Filters"})," section. Multiple values of the same stream fields are ORed together and values of different stream fields are ANDed, e.g. ",(0,s.jsx)(n.code,{children:'service IN ("order-service", "payment-service") AND env IN ("PROD")'}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Then, type the appropriate query in the search box. following are some queries for example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'# find all logs with any non-empty value in _msg field\n*\n\n# find all logs with "error" word in _msg field (case-sensitive)\nerror\n\n# find all logs with "error" word in _msg field (case-insensitive)\ni(error)\n\n# find all logs having "critical error" phrase in _msg field\n"critical error"\n\n# find all logs with "error" word as well as "bug" word in _msg field\nerror AND bug\nerror bug\n\n# find all logs having either "error" word or "failure" word in _msg field\nerror OR failure\n\n# find all logs having "error" word and not having "bug" word in _msg field\nerror NOT bug\nerror -bug\nerror !bug\n\n# find all logs with some word starting with prefix "err" in _msg field\nerr*\n\n# find all logs with "error" word in log.level field\nlog.level:error\n\n# find all logs with exact value "error" in log.level field\nlog.level:=error\n\n# find all logs with exact value "error" or exact value "warn" in log.level field\nlog.level:=error OR log.level:=warn\nlog.level:(=error OR =warn)\nlog.level:in(error, warn)\n\n# Regex (case-sensitive)\nlog.level:~"error|warn"\n\n# Regex (case-insensitive)\nlog.level:~"(?i)(error|warn)"\n'})})]})}function g(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>l});var s=i(6540);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);