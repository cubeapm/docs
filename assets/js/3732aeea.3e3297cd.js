"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6162],{7290:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"logs/ingestion/opentelemetry","title":"OpenTelemetry","description":"OpenTelemetry (OTel) Collector provides powerful capabilities to receive logs from multiple sources, process them, and forward to log storage and visualization platforms like CubeAPM.","source":"@site/docs/logs/ingestion/opentelemetry.md","sourceDirName":"logs/ingestion","slug":"/logs/ingestion/opentelemetry","permalink":"/logs/ingestion/opentelemetry","draft":false,"unlisted":false,"editUrl":"https://github.com/cubeapm/docs/docs/docs/logs/ingestion/opentelemetry.md","tags":[],"version":"current","frontMatter":{"slug":"/logs/ingestion/opentelemetry"},"sidebar":"tutorialSidebar","previous":{"title":"Logstash","permalink":"/logs/ingestion/logstash"},"next":{"title":"Querying","permalink":"/logs/querying"}}');var r=n(4848),l=n(8453);const s={slug:"/logs/ingestion/opentelemetry"},i="OpenTelemetry",a={},c=[{value:"Installation",id:"installation",level:2},{value:"Method 1: Simplified Installation (Recommended)",id:"method-1-simplified-installation-recommended",level:3},{value:"Method 2: Manual Installation",id:"method-2-manual-installation",level:3},{value:"Configuration",id:"configuration",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"opentelemetry",children:"OpenTelemetry"})}),"\n",(0,r.jsx)(t.p,{children:"OpenTelemetry (OTel) Collector provides powerful capabilities to receive logs from multiple sources, process them, and forward to log storage and visualization platforms like CubeAPM."}),"\n",(0,r.jsxs)(t.p,{children:["OTel Collector can be installed on Linux, Windows, and Mac. Pre-built packages for popular package managers (apt, rpm, etc.) are available at ",(0,r.jsx)(t.a,{href:"https://github.com/open-telemetry/opentelemetry-collector-releases/releases",children:"https://github.com/open-telemetry/opentelemetry-collector-releases/releases"}),". Visit the link, look for ",(0,r.jsx)(t.code,{children:"Assets"})," for the latest release, and click on ",(0,r.jsx)(t.code,{children:"Show all xxx assets"})," link at the bottom of the assets list. Then look at links starting with ",(0,r.jsx)(t.code,{children:"otelcol-contrib_"})," and find the appropriate one for your os platform. For example, the one for Ubuntu running on 64-bit ARM processors will be named like ",(0,r.jsx)(t.code,{children:"otelcol-contrib_xxx_linux_arm64.deb"}),"."]}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["There are two variants of OTel Collector available - ",(0,r.jsx)(t.strong,{children:"core"})," (names starting with ",(0,r.jsx)(t.code,{children:"otelcol_"}),") and ",(0,r.jsx)(t.strong,{children:"contrib"})," (names starting with ",(0,r.jsx)(t.code,{children:"otelcol-contrib_"}),"). The core variant is bare-bones, while the contrib variant has a number of additional modules. Infra monitoring makes use of many of these additional modules, and hence needs the contrib variant."]})}),"\n",(0,r.jsx)(t.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsx)(t.h3,{id:"method-1-simplified-installation-recommended",children:"Method 1: Simplified Installation (Recommended)"}),"\n",(0,r.jsx)(t.p,{children:"We provide a simplified installation script that automatically detects your OS and architecture, and installs the appropriate OpenTelemetry Collector Contrib version with custom configuration."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'sudo /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/cubeapm/Otel-contrib-installation/main/otel-contrib-install.sh)" -- --version 0.141.0\n\n'})}),"\n",(0,r.jsx)(t.h3,{id:"method-2-manual-installation",children:"Method 2: Manual Installation"}),"\n",(0,r.jsx)(t.p,{children:"Here we show the manual installation steps for Ubuntu. Steps for other linux variants are similar. (See the bottom of this section for installation on Windows)"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"# change the link to the appropriate link for your os, cpu architecture, collector version, etc.\nwget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.141.0/otelcol-contrib_0.141.0_linux_arm64.deb\n\ndpkg -i otelcol-contrib_0.141.0_linux_arm64.deb\n\n# the package file can now be removed\n# rm otelcol-contrib_0.141.0_linux_arm64.deb\n\n# edit the config as desired (refer the configuration section below)\nvi /etc/otelcol-contrib/config.yaml\n\n# restart collector service\nsystemctl restart otelcol-contrib.service\nsystemctl status otelcol-contrib.service\n"})}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"Installation on Windows"}),(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Download the appropriate ",(0,r.jsx)(t.code,{children:".tar.gz"})," file for windows platform."]}),"\n",(0,r.jsxs)(t.li,{children:["Unzip it by executing ",(0,r.jsx)(t.code,{children:"tar -xzf <filename>"})," command in powershell."]}),"\n",(0,r.jsx)(t.li,{children:"Update config.yaml as desired (refer the configuration section below)."}),"\n",(0,r.jsxs)(t.li,{children:["Run the Collector by executing ",(0,r.jsx)(t.code,{children:"otelcol-contrib.exe --config config.yaml"})," in powershell."]}),"\n"]}),(0,r.jsx)(t.p,{children:"The Collector can be set up as a background service as follows:"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'# Create windows service.\n# Modify the paths of otelcol-contrib.exe and config.yaml as appropriate.\n# Ref: https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create\nsc.exe create otelcol displayname= otelcol start= delayed-auto binPath= "C:\\Users\\Administrator\\Desktop\\otelcol-contrib\\otelcol-contrib.exe --config C:\\Users\\Administrator\\Desktop\\otelcol-contrib\\config.yaml"\n\n# Useful commands\nsc.exe start otelcol\nsc.exe query otelcol\nsc.exe delete otelcol\n\n# To check the logs, open event viewer > windows logs > application,\n# and then filter source=otelcol on right hand side.\n'})})]}),"\n",(0,r.jsx)(t.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(t.p,{children:"Here's a sample OTel Collector configuration file for logs."}),"\n",(0,r.jsxs)(n,{children:[(0,r.jsx)("summary",{children:"config.yaml"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:'receivers:\n  # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/filelogreceiver#file-log-receiver\n  filelog:\n    include:\n      - /logs/*.log\n    # exclude: []\n    preserve_leading_whitespaces: true\n    # Note: `include_file_path` must not be set to false, else recombine\n    # operator will mix up logs from different files.\n    include_file_path: true\n    # include_file_name can be det to false as we are including full filepath above.\n    include_file_name: false\n\n    # The maximum size of a log entry to read. A log entry will be truncated if it is\n    # larger than max_log_size. Protects against reading large amounts of data into memory.\n    # max_log_size: 1MiB\n\n    # A map of key: value pairs to add to the entry\'s attributes.\n    # attributes: {}\n    # A map of key: value pairs to add to the entry\'s resource.\n    # resource: {}\n\n    # The ID of a storage extension to be used to store file offsets. File offsets allow the\n    # receiver to pick up where it left off in the case of a collector restart. If no storage\n    # extension is used, the receiver will manage offsets in memory only.\n    storage: file_storage\n\n    retry_on_failure:\n      enabled: true\n      # initial_interval: 1s\n      # max_interval: 30s\n      # max_elapsed_time: 5m\n\n    # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/operators/README.md\n    operators:\n      # The container operator parses logs in docker, cri-o and containerd formats.\n      # Uncomment if running in container environment.\n      # - id: container-parser\n      #   type: container\n      #   max_log_size: 1000000\n\n      # - id: filter\n      #   type: filter\n      #   # matching logs are DROPPED\n      #   expr: <expression>\n\n      # Format specific handling\n      # Step 1: Detect format and send logs to respective handlers.\n      - id: format_handler_router\n        type: router\n        routes:\n          - expr: attributes["log.file.path"] == "/logs/java_app.log"\n            output: java_parser\n        # Send logs to end_of_format_handler\n        default: end_of_format_handler\n\n      # Step 2: Process each format (repeat for each format)\n      - id: java_parser\n        type: noop\n      - id: java_multiline\n        type: recombine\n        combine_field: body\n        is_first_entry: body matches "^\\\\d{4}-\\\\d{2}-\\\\d{2}"\n        # force_flush_period: 5s\n        # source_identifier: attributes["log.file.path"]\n      - id: java_extract_fields\n        type: regex_parser\n        regex: (?P<timestamp_field>\\d{4}-\\d{2}-\\d{2}\\s+\\d{2}:\\d{2}:\\d{2}(?:[,.]\\d+)?[+-]\\d{2}:\\d{2})\\s+\\[(?P<severity_field>[A-Z]+)\\]\\s+(?P<message>.+)\n        # if: <expression>\n        # parse_from: body\n        # parse_to: attributes\n        # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/types/timestamp.md\n        timestamp:\n          parse_from: attributes.timestamp_field\n          layout_type: strptime\n          layout: "%Y-%m-%d %H:%M:%S.%s%j"\n          # Specify time zone if needed\n          # location: Local\n        # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/types/severity.md\n        severity:\n          parse_from: attributes.severity_field\n          # preset: default\n          # mapping:\n          #   error: 5xx\n          # Replace incoming text with standard shaort name for consistency.\n          overwrite_text: true\n      - id: java_finish\n        type: noop\n        output: end_of_format_handler\n\n      # Step 3: Finish multiline handling\n      - id: end_of_format_handler\n        type: noop\n\n      # - id: remove_timestamp_field\n      #   type: remove\n      #   field: attributes.timestamp_field\n      # - id: remove_severity_field\n      #   type: remove\n      #   field: attributes.severity_field\n\n      # Add more operators if needed\n      # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/operators/README.md\n\nprocessors:\n  batch: {}\n\n  resourcedetection:\n    detectors: ["system"]\n    system:\n      hostname_sources: ["os"]\n\n  # resource/cube.environment:\n  #   attributes:\n  #     - key: cube.environment\n  #       value: UNSET\n  #       action: upsert\n\n  transform/logs_parse_json_body:\n    error_mode: ignore\n    log_statements:\n      - context: log\n        conditions:\n          - body != nil and IsString(body) and Substring(body, 0, 2) == "{\\""\n        statements:\n          - set(cache, ParseJSON(body))\n          - flatten(cache, "")\n          - merge_maps(attributes, cache, "upsert")\n\n  # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/filterprocessor\n  # filter/logs:\n  #   error_mode: ignore\n  #   logs:\n  #     log_record:\n  #       # matching logs are DROPPED\n  #       - log.severity_text != "ERROR" AND log.severity_text != "FATAL"\n\n  # transform/logs_redact:\n  #   error_mode: ignore\n  #   log_statements:\n  #     - context: log\n  #       statements:\n  #         # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/ottl/ottlfuncs#replace_pattern\n  #         # - replace_pattern(attributes["http.url"], "client_id=[^&]+", "client_id=[REDACTED]")\n  #         - replace_pattern(body, "\\"(token|password)\\":\\"[^\\"]*\\"", "\\"$$1\\":\\"****\\"")\n\n  # Filelog operators should be preferred for extracting fields, as they offer\n  # advanced capability of conditional routing etc. This section is provided\n  # here just for reference in case some use-case comes up.\n  # transform/logs_extract_fields:\n  #   error_mode: ignore\n  #   log_statements:\n  #     - context: log\n  #       statements:\n  #         # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/pkg/ottl/ottlfuncs#extractpatterns\n  #         - merge_maps(attributes, ExtractPatterns(body, "\\\\[(?P<log_level>TRACE|DEBUG|INFO|WARN|WARNING|ERROR|FATAL)\\\\]"), "upsert")\n  #         - merge_maps(attributes, ExtractPatterns(body, "\\\\[(?P<log_level>trace|debug|info|warn|warning|error|fatal)\\\\]"), "upsert")\n  #         - merge_maps(attributes, ExtractPatterns(body, "\\\\s+level=(?P<log_level>trace|debug|info|warn|warning|error|fatal)\\\\s+"), "upsert")\n  #         - merge_maps(attributes, ExtractPatterns(body, "\\\\s+-\\\\s+(?P<log_level>TRACE|DEBUG|INFO|WARN|WARNING|ERROR|FATAL)\\\\s+-\\\\s+"), "upsert")\n  #         # map to severity_text and severity_number\n  #         # ("Trace", 1), ("Debug", 5), ("Info", 9), ("Warn", 13), ("Error", 17), ("Fatal", 21)\n  #         # Ref: https://github.com/open-telemetry/opentelemetry-collector/blob/v0.129.0/pdata/plog/severity_number.go\n  #         - set(attributes["log_level"], ToUpperCase(attributes["log_level"])) where attributes["log_level"] != nil\n  #         - set(severity_text, "Trace") where attributes["log_level"] == "TRACE"\n  #         - set(severity_number, 1) where attributes["log_level"] == "TRACE"\n  #         - set(severity_text, "Debug") where attributes["log_level"] == "DEBUG"\n  #         - set(severity_number, 5) where attributes["log_level"] == "DEBUG"\n  #         - set(severity_text, "Info") where attributes["log_level"] == "INFO"\n  #         - set(severity_number, 9) where attributes["log_level"] == "INFO"\n  #         - set(severity_text, "Warn") where attributes["log_level"] == "WARN" or attributes["log_level"] == "WARNING"\n  #         - set(severity_number, 13) where attributes["log_level"] == "WARN" or attributes["log_level"] == "WARNING"\n  #         - set(severity_text, "Error") where attributes["log_level"] == "ERROR"\n  #         - set(severity_number, 17) where attributes["log_level"] == "ERROR"\n  #         - set(severity_text, "Fatal") where attributes["log_level"] == "FATAL"\n  #         - set(severity_number, 21) where attributes["log_level"] == "FATAL"\n\nexporters:\n  debug: {}\n\n  otlphttp/logs:\n    logs_endpoint: http://<cubeapm_host>:3130/api/logs/insert/opentelemetry/v1/logs\n    headers:\n      Cube-Stream-Fields: log.file.path,severity\n    retry_on_failure:\n      enabled: true\n      # initial_interval: 5s\n      # max_interval: 30s\n      # Set max_elapsed_time to longer value to survive longer outages of CubeAPM.\n      # max_elapsed_time: 5m\n    sending_queue:\n      enabled: true\n      # Queue depth limit. When this limit is reached, the exporter will start dropping logs.\n      queue_size: 5000 # number of log batches, not logs.\n      storage: file_storage\n\nextensions:\n  file_storage:\n    directory: /var/lib/otelcol\n\nservice:\n  extensions: [file_storage]\n\n  pipelines:\n    logs:\n      receivers:\n        - filelog\n      processors:\n        - transform/logs_parse_json_body\n        # - transform/logs_extract_fields\n        # - filter/logs\n        # - transform/logs_redact\n        - resourcedetection\n        # - resource/cube.environment\n        - batch\n      exporters:\n        # Uncomment to see final logs in collector\'s logs output.\n        # - debug\n        - otlphttp/logs\n\n  telemetry:\n    logs:\n      level: info\n    metrics:\n      readers:\n        - pull:\n            exporter:\n              prometheus:\n                host: localhost\n                port: 8888\n'})})]}),"\n",(0,r.jsxs)(t.p,{children:["A sample project with working Docker Compose setup is available at ",(0,r.jsx)(t.a,{href:"https://github.com/cubeapm/sample_logs_pipeline_otel",children:"https://github.com/cubeapm/sample_logs_pipeline_otel"}),"."]})]})}function p(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var o=n(6540);const r={},l=o.createContext(r);function s(e){const t=o.useContext(l);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(l.Provider,{value:t},e.children)}}}]);