"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6555],{3804:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"instrumentation/opentelemetry/nodeJs-fastify","title":"NodeJS Fastify","description":"Installation","source":"@site/docs/instrumentation/opentelemetry/nodeJS-fastify.md","sourceDirName":"instrumentation/opentelemetry","slug":"/instrumentation/opentelemetry/nodejs-fastify","permalink":"/instrumentation/opentelemetry/nodejs-fastify","draft":false,"unlisted":false,"editUrl":"https://github.com/cubeapm/docs/docs/docs/instrumentation/opentelemetry/nodeJS-fastify.md","tags":[],"version":"current","frontMatter":{"id":"nodeJs-fastify","title":"NodeJS Fastify","slug":"/instrumentation/opentelemetry/nodejs-fastify"},"sidebar":"tutorialSidebar","previous":{"title":"NodeJS Express","permalink":"/instrumentation/opentelemetry/nodejs-express"},"next":{"title":"NodeJS Nest","permalink":"/instrumentation/opentelemetry/nodejs-nest"}}');var o=t(4848),i=t(8453);const r={id:"nodeJs-fastify",title:"NodeJS Fastify",slug:"/instrumentation/opentelemetry/nodejs-fastify"},a=void 0,l={},c=[{value:"Installation",id:"installation",level:2},{value:"Sample App",id:"sample-app",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Install dependencies"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"npm install --save @opentelemetry/auto-instrumentations-node @fastify/otel\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Create a file ",(0,o.jsx)(n.code,{children:"tracing.js"})," in your project directory, with the following content:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",metastring:'title="tracing.js"',children:'"use strict";\nconst process = require("process");\nconst { diag, DiagConsoleLogger, DiagLogLevel } = require("@opentelemetry/api");\nconst opentelemetry = require("@opentelemetry/sdk-node");\nconst {\n  getNodeAutoInstrumentations,\n} = require("@opentelemetry/auto-instrumentations-node");\nconst {\n  OTLPTraceExporter,\n} = require("@opentelemetry/exporter-trace-otlp-proto");\nconst { FastifyOtelInstrumentation } = require(\'@fastify/otel\');\n\nif (process.env.OTEL_LOG_LEVEL === "debug") {\n  diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.INFO);\n}\n\nconst exporterOptions = {\n  // concurrencyLimit: 1,\n};\nconst traceExporter =\n  process.env.OTEL_LOG_LEVEL === "debug"\n    ? new opentelemetry.tracing.ConsoleSpanExporter()\n    : new OTLPTraceExporter(exporterOptions);\n\nconst sdk = new opentelemetry.NodeSDK({\n  traceExporter,\n  instrumentations: [\n    ...Object.values(\n      getNodeAutoInstrumentations({\n        "@opentelemetry/instrumentation-fs": { enabled: false },\n      })\n    ),\n    new FastifyOtelInstrumentation({\n      registerOnInitialization: true,\n    }),\n  ],\n});\n\n// initialize the SDK and register with the OpenTelemetry API\n// this enables the API to record telemetry\nsdk.start();\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Modify the application run command as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'OTEL_METRICS_EXPORTER=otlp \\\nOTEL_LOGS_EXPORTER=none \\\nOTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://<ip_address_of_cubeapm_server>:4318/v1/traces \\\nOTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://<ip_address_of_cubeapm_server>:3130/api/metrics/v1/save/otlp \\\nOTEL_EXPORTER_OTLP_COMPRESSION=gzip \\\nOTEL_SERVICE_NAME=<app_name> \\\nNODE_OPTIONS="--require ./tracing.js" \\\nnode app.js\n'})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["If the application is running in PM2 cluster mode, then setting NODE_OPTIONS does not work. In this case, add ",(0,o.jsx)(n.code,{children:"require('./tracing.js');"})," as the first line in your application code."]})}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsxs)(n.p,{children:["If the application is configured to compile as a ",(0,o.jsx)(n.strong,{children:"module"})," (",(0,o.jsx)(n.code,{children:"type: 'module'"})," in package.json), then make the below changes for the instrumentation to work properly:"]}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Change ",(0,o.jsx)(n.code,{children:"require"})," statements to corresponding ",(0,o.jsx)(n.code,{children:"import"})," statements in tracing.js."]}),"\n",(0,o.jsxs)(n.li,{children:["Change the commans line arguments (or NODE_OPTIONS) to ",(0,o.jsx)(n.code,{children:"--import ./tracing.js --experimental-loader=@opentelemetry/instrumentation/hook.mjs"}),"."]}),"\n"]}),(0,o.jsxs)(n.p,{children:["For further details, please refer: ",(0,o.jsx)(n.a,{href:"https://github.com/open-telemetry/opentelemetry-js/blob/main/doc/esm-support.md",children:"https://github.com/open-telemetry/opentelemetry-js/blob/main/doc/esm-support.md"})]})]}),"\n",(0,o.jsx)(n.h3,{id:"sample-app",children:"Sample App"}),"\n",(0,o.jsxs)(n.p,{children:["A working example with multiple instrumentations is available at ",(0,o.jsx)(n.a,{href:"https://github.com/cubeapm/sample_app_nodejs_fastify/tree/otel",children:"https://github.com/cubeapm/sample_app_nodejs_fastify/tree/otel"})]}),"\n",(0,o.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsx)(n.p,{children:"The following can be used for debugging:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"# print traces on console\nOTEL_LOG_LEVEL=debug\n# print metrics on console\nOTEL_METRICS_EXPORTER=console\n"})}),"\n",(0,o.jsx)(n.p,{children:"The following command can be tried on the application host server to check connectivity to CubeAPM server(s):"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"telnet <ip_address_of_cubeapm_server> 4318\n"})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(6540);const o={},i=s.createContext(o);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);