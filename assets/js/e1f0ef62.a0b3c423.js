"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[646],{6572:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"instrumentation/opentelemetry/nodeJs-express","title":"NodeJS Express","description":"Installation","source":"@site/docs/instrumentation/opentelemetry/nodeJS-express.md","sourceDirName":"instrumentation/opentelemetry","slug":"/instrumentation/opentelemetry/nodejs-express","permalink":"/instrumentation/opentelemetry/nodejs-express","draft":false,"unlisted":false,"editUrl":"https://github.com/cubeapm/docs/docs/docs/instrumentation/opentelemetry/nodeJS-express.md","tags":[],"version":"current","frontMatter":{"id":"nodeJs-express","title":"NodeJS Express","slug":"/instrumentation/opentelemetry/nodejs-express"},"sidebar":"tutorialSidebar","previous":{"title":"Java","permalink":"/instrumentation/opentelemetry/java"},"next":{"title":"NodeJS Nest","permalink":"/instrumentation/opentelemetry/nodejs-nest"}}');var s=t(4848),o=t(8453);const i={id:"nodeJs-express",title:"NodeJS Express",slug:"/instrumentation/opentelemetry/nodejs-express"},a=void 0,l={},c=[{value:"Installation",id:"installation",level:2},{value:"Sample App",id:"sample-app",level:3},{value:"Capture Exception StackTraces (optional)",id:"capture-exception-stacktraces-optional",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Install dependencies"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm install --save @opentelemetry/auto-instrumentations-node\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a file ",(0,s.jsx)(n.code,{children:"tracing.js"})," in your project directory, with the following content:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:'title="tracing.js"',children:'"use strict";\nconst process = require("process");\nconst {\n  diag,\n  DiagConsoleLogger,\n  DiagLogLevel,\n} = require("@opentelemetry/api");\nconst opentelemetry = require("@opentelemetry/sdk-node");\nconst {\n  getNodeAutoInstrumentations,\n} = require("@opentelemetry/auto-instrumentations-node");\nconst {\n  OTLPTraceExporter,\n} = require("@opentelemetry/exporter-trace-otlp-proto");\n\nif (process.env.OTEL_LOG_LEVEL === "debug") {\n  diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.INFO);\n}\n\nconst exporterOptions = {\n  // concurrencyLimit: 1,\n};\nconst traceExporter =\n  process.env.OTEL_LOG_LEVEL === "debug"\n    ? new opentelemetry.tracing.ConsoleSpanExporter()\n    : new OTLPTraceExporter(exporterOptions);\n\nconst sdk = new opentelemetry.NodeSDK({\n  traceExporter,\n  instrumentations: getNodeAutoInstrumentations({\n    "@opentelemetry/instrumentation-fs": {\n      enabled: false,\n    },\n  }),\n});\n\n// initialize the SDK and register with the OpenTelemetry API\n// this enables the API to record telemetry\nsdk.start();\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Modify the application run command as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'OTEL_METRICS_EXPORTER=none \\\nOTEL_LOGS_EXPORTER=none \\\nOTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://<ip_address_of_cubeapm_server>:4318/v1/traces \\\nOTEL_EXPORTER_OTLP_COMPRESSION=gzip \\\nOTEL_SERVICE_NAME=<app_name> \\\nNODE_OPTIONS="--require ./tracing.js" \\\nnode app.js\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["If the application is running in PM2 cluster mode, then setting NODE_OPTIONS does not work. In this case, add ",(0,s.jsx)(n.code,{children:"require('./tracing.js');"})," as the first line in your application code."]})}),"\n",(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsxs)(n.p,{children:["If the application is configured to compile as a ",(0,s.jsx)(n.strong,{children:"module"})," (",(0,s.jsx)(n.code,{children:"type: 'module'"})," in package.json), then make the below changes for the instrumentation to work properly:"]}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Change ",(0,s.jsx)(n.code,{children:"require"})," statements to corresponding ",(0,s.jsx)(n.code,{children:"import"})," statements in tracing.js."]}),"\n",(0,s.jsxs)(n.li,{children:["Change the commans line arguments (or NODE_OPTIONS) to ",(0,s.jsx)(n.code,{children:"--import ./tracing.js --experimental-loader=@opentelemetry/instrumentation/hook.mjs"}),"."]}),"\n"]}),(0,s.jsxs)(n.p,{children:["For further details, please refer: ",(0,s.jsx)(n.a,{href:"https://github.com/open-telemetry/opentelemetry-js/blob/main/doc/esm-support.md",children:"https://github.com/open-telemetry/opentelemetry-js/blob/main/doc/esm-support.md"})]})]}),"\n",(0,s.jsx)(n.h3,{id:"sample-app",children:"Sample App"}),"\n",(0,s.jsxs)(n.p,{children:["A working example with multiple instrumentations is available at ",(0,s.jsx)(n.a,{href:"https://github.com/cubeapm/sample_app_nodejs_express/tree/otel",children:"https://github.com/cubeapm/sample_app_nodejs_express/tree/otel"})]}),"\n",(0,s.jsx)(n.h2,{id:"capture-exception-stacktraces-optional",children:"Capture Exception StackTraces (optional)"}),"\n",(0,s.jsx)(n.p,{children:"CubeAPM shows stacktraces for any exceptions that occur in your application. However, if you are using the Express framework, you need to add the following code to your Express error handler to capture the stacktraces:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import express, { Express, ErrorRequestHandler } from "express";\n// highlight-next-line\nimport { trace } from "@opentelemetry/api";\n\nconst app: Express = express();\n\napp.get("/", (req, res) => {\n  throw new Error("Test throw error!");\n});\n\nconst errorHandler: ErrorRequestHandler = (err, req, res, next) => {\n  // highlight-start\n  const span = trace.getActiveSpan();\n  if (span) {\n    span.recordException(err);\n  }\n  // highlight-end\n\n  // pass the error to the next middleware\n  // you can do any custom error handling here\n  next(err);\n};\n\napp.use(errorHandler);\n\napp.listen(8080);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.p,{children:"The following can be used for debugging:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"OTEL_LOG_LEVEL=debug\n"})}),"\n",(0,s.jsx)(n.p,{children:"The following command can be tried on the application host server to check connectivity to CubeAPM server(s):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"telnet <ip_address_of_cubeapm_server> 4318\n"})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);